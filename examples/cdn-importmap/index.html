<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>My Graffiti App</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script type="importmap">
            {
                "imports": {
                    "vue": "https://cdn.jsdelivr.net/npm/vue/dist/vue.esm-browser.prod.js",
                    "@graffiti-garden/wrapper-vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-vue@0.0.5/dist/plugin.js",
                    "@graffiti-garden/implementation-local": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-local@0.2.5/dist/index.browser.js"
                }
            }
        </script>
        <style>
            .waving {
                animation: wave 1s infinite;
            }
            @keyframes wave {
                0% {
                    transform: rotate(0deg);
                }
                25% {
                    transform: rotate(15deg);
                }
                50% {
                    transform: rotate(0deg);
                }
                75% {
                    transform: rotate(-15deg);
                }
                100% {
                    transform: rotate(0deg);
                }
            }
        </style>
    </head>
    <body>
        <div id="app"></div>
        <template id="my-template">
            <h1>My Graffiti App</h1>
            <p>
                This is an example of a
                <a href="https://graffiti.garden">Graffiti</a> app built with
                <a href="https://vuejs.org"> Vue.js </a> in a single HTML file.
                Right click and choose "View Page Source" to see the complete
                source code or see it in context
                <a
                    href="https://github.com/graffiti-garden/wrapper-vue/tree/main/examples/cdn-importmap"
                    >on Github</a
                >. This app imports the
                <a href="https://github.com/graffiti-garden/wrapper-vue"
                    >Graffiti Vue.js wrapper</a
                >
                and the
                <a
                    href="https://github.com/graffiti-garden/implementation-local"
                    >PouchDB implementation of Graffiti</a
                >
                via CDN using an
                <a
                    href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script/type/importmap"
                    >import map</a
                >.
            </p>

            <!--vvvv Begin login vvvv-->
            <p v-if="$graffitiSession.value">
                Logged in as: {{ $graffitiSession.value.actor }}
                <button @click="$graffiti.logout($graffitiSession.value)">
                    Log out
                </button>
            </p>
            <p v-else-if="$graffitiSession.value === null">
                <button @click="$graffiti.login()">Log in</button>
            </p>
            <p v-else>
                <button>Loading...</button>
            </p>
            <!--^^^^ End login ^^^^-->

            <!--vvvv Begin waves vvvv-->
            <graffiti-discover
                v-slot="{ results: waves, isPolling }"
                :channels="[ channel ]"
                :schema="{
                    properties: {
                        value: {
                            required: ['activity'],
                            properties: {
                                activity: { enum: ['Wave'] }
                            }
                        }
                    }
                }"
            >
                <template v-if="$graffitiSession.value">
                    <button
                        v-if="!waves.some(
                            wave => wave.actor === $graffitiSession.value.actor
                        )"
                        @click="$graffiti.put({
                            value: { activity: 'Wave' },
                            channels: [ channel ]
                        }, $graffitiSession.value)"
                    >
                        ðŸ‘‹
                    </button>
                    <button
                        v-else
                        class="waving"
                        @click="waves.filter(
                            wave => wave.actor === $graffitiSession.value.actor
                        ).map(wave => $graffiti.delete(wave, $graffitiSession.value))"
                    >
                        ðŸ‘‹
                    </button>
                </template>
                <template v-else>
                    <p>To wave ðŸ‘‹ you need to be logged in.</p>
                </template>

                <p v-if="isPolling">Loading...</p>
                <p v-else>
                    {{ waves.length }} people have waved from this page~
                </p>
            </graffiti-discover>
            <!--^^^^ End waves ^^^^-->

            <!--vvvv Begin posts vvvv-->
            <graffiti-discover
                v-slot="{ results: posts, isPolling }"
                :channels="[ channel ]"
                :schema="{
                    properties: {
                        value: {
                            required: ['content'],
                            properties: {
                                content: { type: 'string' }
                            }
                        }
                    }
                }"
            >
                <form
                    @submit.prevent="$graffiti.put({
                        value: { content },
                        channels: [ channel ]
                    }, $graffitiSession.value)"
                >
                    <label for="post">Post:</label>
                    <input id="post" v-model="content" />
                    <input type="submit" value="Post" />
                </form>
                <ul>
                    <li v-for="post in posts">
                        <div>{{ post.actor }}</div>
                        <div>
                            {{ new Date(post.lastModified).toLocaleString() }}
                        </div>
                        <div
                            class="content"
                            v-if="editing !== $graffiti.objectToUri(post)"
                        >
                            {{ post.value.content }}
                        </div>
                        <form
                            v-else
                            @submit.prevent="
                                savingEdits = true;
                                $graffiti.patch(
                                    {
                                        value: [{ op: 'replace', path: '/content', value: editText }],
                                    },
                                    post,
                                    $graffitiSession.value
                                ).then(() => {
                                    savingEdits = false;
                                    editing = '';
                                });"
                        >
                            <input type="text" v-model="editText" />
                            <input
                                type="submit"
                                :value="savingEdits ? 'Saving...' : 'Save'"
                                :disabled="savingEdits"
                            />
                        </form>
                        <menu
                            v-if="post.actor === $graffitiSession.value?.actor"
                        >
                            <li>
                                <button
                                    @click="$graffiti.delete(post, $graffitiSession.value)"
                                >
                                    Delete
                                </button>
                            </li>
                            <li>
                                <button
                                    @click="
                                        editText = post.value.content;
                                        editing = $graffiti.objectToUri(post);"
                                >
                                    Edit
                                </button>
                            </li>
                        </menu>
                    </li>
                </ul>
            </graffiti-discover>
            <!--vvvv End posts ^^^^-->
        </template>
        <script type="module">
            import { createApp } from "vue";
            import { GraffitiPlugin } from "@graffiti-garden/wrapper-vue";
            import { GraffitiLocal } from "@graffiti-garden/implementation-local";

            createApp({
                template: document.getElementById("my-template").innerHTML,
                // Declare reactive data
                data() {
                    return {
                        channel: window.location.href,
                        content: "",
                        editing: "",
                        editText: "",
                        savingEdits: false,
                    };
                },
            })
                .use(GraffitiPlugin, {
                    useGraffiti: () => new GraffitiLocal(),
                })
                .mount("#app");
        </script>
    </body>
</html>
